# apiVersion: scaffolder.backstage.io/v1beta3
# # https://backstage.io/docs/features/software-catalog/descriptor-format#kind-template
# kind: Template
# metadata:
#   name: eks-cluster-template-bitbucket
#   title: Example EKS Cluster Template
#   description: An example template for the scaffolder that creates a simple EKS cluster 
# spec:
#   owner: user:guest
#   type: service

#   # These parameters are used to generate the input form in the frontend, and are
#   # used to gather input data for the execution of the template.
#   parameters:
#     - title: Fill in some steps
#       required:
#         - name
#       properties:
#         name:
#           title: Name
#           type: string
#           description: Unique name of the component
#           ui:autofocus: true
#           ui:options:
#             rows: 5
#     - title: Choose a location
#       required:
#         - repoUrl
#       properties:
#         repoUrl:
#           title: Repository Location
#           type: string
#           ui:field: RepoUrlPicker
#           ui:options:
#             allowedHosts:
#               - github.com

#   # These steps are executed in the scaffolder backend, using data that we gathered
#   # via the parameters above.
#   steps:
#     # Each step executes an action, in this case one templates files into the working directory.
#     - id: fetch-base
#       name: Fetch Base
#       action: fetch:cookiecutter
#       input:
#         url: ./content
#         values:
#           project_name: ${{ parameters.name }}
#           repoUrl: ${{ parameters.repoUrl }}
#           destination: ${{ parameters.repoUrl | parseRepoUrl }}
#       copyWithoutRender:
#         - '.github/*'

#     # This step publishes the contents of the working directory to GitHub.
#     # If you or your organization prefer another default branch name over 'main'
#     # you can change that here.
#     - id: publish
#       name: Publish
#       action: publish:github
#       input:
#         allowedHosts: ['github.com']
#         description: This is ${{ parameters.name }}
#         repoUrl: ${{ parameters.repoUrl }}
#         defaultBranch: 'main'

#     # The final step is to register our new component in the catalog.
#     - id: register
#       name: Register
#       action: catalog:register
#       input:
#         repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
#         catalogInfoPath: '/catalog-info.yaml'

#   # Outputs are displayed to the user after a successful execution of the template.
#   output:
#     links:
#       - title: Repository
#         url: ${{ steps['publish'].output.remoteUrl }}
#       - title: Open in catalog
#         icon: catalog
#         entityRef: ${{ steps['register'].output.entityRef }}



apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: eks-cluster-template-bitbucket-v2
  title: Example EKS Cluster Template v2
  description: An example template for the scaffolder that creates a simple EKS cluster with JSON configuration support
  annotations:
      backstage.io/techdocs-ref: dir:.
      github.com/project-slug: mari0rh/idp-demo-resources
spec:
  owner: user:idiomario1989
  type: service

  parameters:
    - title: Basic Information
      required:
        - name
      properties:
        name:
          title: Name
          type: string
          description: Unique name of the component
          ui:autofocus: true
    - title: Repository Configuration
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Repository Location
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com
    - title: JSON Configuration
      properties:
        jsonInput:
          title: JSON Configuration
          type: string
          ui:widget: textarea
          description: Paste your JSON configuration here
          ui:options:
            rows: 10

  steps:
    - id: fetch-base
      name: Fetch Base
      action: fetch:cookiecutter
      input:
        url: ./content-bitbucket/EKS_Cluster_Template
        values:
          project_name: ${{ parameters.name }}
          repoUrl: ${{ parameters.repoUrl }}
          destination: ${{ parameters.repoUrl | parseRepoUrl }}
          json_config: ${{ parameters.jsonInput }}
      copyWithoutRender:
        - '.github/*'

    - id: publish
      name: Publish
      action: publish:github
      input:
        allowedHosts: ['github.com']
        description: This is ${{ parameters.name }}
        repoUrl: ${{ parameters.repoUrl }}
        defaultBranch: 'main'

    - id: register
      name: Register
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish'].output.repoContentsUrl }}
        catalogInfoPath: '/catalog-info.yaml'

  output:
    links:
      - title: Repository
        url: ${{ steps['publish'].output.remoteUrl }}
      - title: Open in catalog
        icon: catalog
        entityRef: ${{ steps['register'].output.entityRef }}
